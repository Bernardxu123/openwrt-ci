name: IPQ60XX-24.10-6.12-WIFI

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'configs/ipq60xx-6.12-wifi.config'
      - 'diy-script.sh'
      - 'feeds/6.12.txt'

env:
  REPO_URL: https://github.com/LiBwrt/openwrt-6.x.git
  REPO_BRANCH: main-nss
  CONFIG_FILE: configs/ipq60xx-6.12-wifi.config
  FEEDS_FILE: feeds/6.12.txt
  DIY_SCRIPT: diy-script.sh
  UPLOAD_BIN_DIR: false
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  FIRMWARE_TAG: IPQ60XX-JDCloud-RE-SS-01
  TZ: Asia/Shanghai

jobs:
  Build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@main

    - name: Check Server Performance
      run: |
        echo "è­¦å‘Šâš "
        echo "åˆ†é…çš„æœåŠ¡å™¨æ€§èƒ½æœ‰é™ï¼Œè‹¥é€‰æ‹©çš„æ’ä»¶è¿‡å¤šï¼ŒåŠ¡å¿…æ³¨æ„CPUæ€§èƒ½ï¼"
        echo "--------------------------CPUä¿¡æ¯--------------------------"
        echo "CPUç‰©ç†æ•°é‡ï¼š$(cat /proc/cpuinfo | grep "physical id" | sort | uniq | wc -l)"
        echo -e "CPUæ ¸å¿ƒä¿¡æ¯ï¼š$(cat /proc/cpuinfo | grep name | cut -f2 -d: | uniq -c) \n"
        echo "--------------------------å†…å­˜ä¿¡æ¯--------------------------"
        echo "å·²å®‰è£…å†…å­˜è¯¦ç»†ä¿¡æ¯ï¼š"
        echo -e "$(sudo lshw -short -C memory | grep GiB) \n"
        echo "--------------------------ç¡¬ç›˜ä¿¡æ¯--------------------------"
        echo "ç¡¬ç›˜æ•°é‡ï¼š$(ls /dev/sd* | grep -v [1-9] | wc -l)" && df -hT

    - name: Initialization Environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        docker rmi $(docker images -q) 2>/dev/null || true
        sudo rm -rf /usr/share/dotnet /etc/apt/sources.list.d /usr/local/lib/android $AGENT_TOOLSDIRECTORY
        sudo -E apt-get -y update
        sudo -E apt-get -y install $(curl -fsSL is.gd/depends_ubuntu_2204)
        sudo -E apt-get -y autoremove --purge
        sudo -E apt-get -y clean
        sudo timedatectl set-timezone "$TZ"

    - name: Clone Source Code
      run: |
        git clone $REPO_URL -b $REPO_BRANCH openwrt
        cd openwrt
        echo "OPENWRT_PATH=$PWD" >> $GITHUB_ENV
        VERSION_INFO=$(git show -s --date=short --format="Author: %an<br/>Date: %cd<br/>Message: %s<br/>Hash: %H")
        echo "VERSION_INFO=$VERSION_INFO" >> $GITHUB_ENV

    - name: Install Feeds
      run: |
        cd $OPENWRT_PATH
        # ä½¿ç”¨è‡ªå®šä¹‰ feeds é…ç½®
        cp $GITHUB_WORKSPACE/$FEEDS_FILE feeds.conf.default
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Load Custom Configuration
      run: |
        cd $OPENWRT_PATH
        # è¿è¡Œ DIY è„šæœ¬
        chmod +x $GITHUB_WORKSPACE/$DIY_SCRIPT
        $GITHUB_WORKSPACE/$DIY_SCRIPT
        # åŠ è½½é…ç½®
        cp $GITHUB_WORKSPACE/$CONFIG_FILE .config
        # è‡ªåŠ¨åº”ç­”æ‰€æœ‰æ–°é…ç½®é€‰é¡¹ï¼ˆä½¿ç”¨é»˜è®¤å€¼ï¼‰
        yes "" | make oldconfig || make defconfig

    - name: Download DL Package
      run: |
        cd $OPENWRT_PATH
        make download -j8
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;

    - name: Compile Firmware
      id: compile
      run: |
        cd $OPENWRT_PATH
        echo -e "$(nproc) thread compile"
        make -j$(nproc) || make -j1 V=s
        echo "status=success" >> $GITHUB_OUTPUT
        echo "DATE=$(date +"%Y-%m-%d %H:%M")" >> $GITHUB_ENV
        echo "FILE_DATE=$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV

    - name: Check Space Usage
      if: always()
      run: df -hT

    - name: Organize Files
      if: steps.compile.outputs.status == 'success'
      run: |
        cd $OPENWRT_PATH/bin/targets/*/*
        rm -rf packages
        echo "FIRMWARE_PATH=$PWD" >> $GITHUB_ENV
        echo "DEVICE_TARGET=$(basename $(dirname $PWD))" >> $GITHUB_ENV
        echo "DEVICE_SUBTARGET=$(basename $PWD)" >> $GITHUB_ENV

    - name: Upload Firmware To Artifact
      if: steps.compile.outputs.status == 'success' && env.UPLOAD_FIRMWARE == 'true'
      uses: actions/upload-artifact@main
      with:
        name: OpenWrt-${{ env.FIRMWARE_TAG }}-${{ env.FILE_DATE }}
        path: ${{ env.FIRMWARE_PATH }}

    - name: Upload Firmware To Release
      if: steps.compile.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true'
      uses: ncipollo/release-action@v1
      with:
        name: R${{ env.DATE }} for ${{ env.FIRMWARE_TAG }}
        allowUpdates: true
        tag: ${{ env.FIRMWARE_TAG }}
        token: ${{ secrets.GITHUB_TOKEN }}
        artifacts: ${{ env.FIRMWARE_PATH }}/*
        body: |
          **OpenWrt Firmware for JDCloud RE-SS-01 (IPQ6010)**
          
          ### ğŸ“’ å›ºä»¶ä¿¡æ¯
          - ğŸ’» è®¾å¤‡: JDCloud RE-SS-01 (IPQ6010)
          - ğŸ“¦ å†…æ ¸: 6.12 with WiFi & NSS
          - âš½ æºç : ${{ env.REPO_URL }}
          - ğŸ’ åˆ†æ”¯: ${{ env.REPO_BRANCH }}
          - ğŸŒ é»˜è®¤IP: 192.168.1.1
          - ğŸ”‘ é»˜è®¤å¯†ç : password
          
          ### âœ¨ é¢„è£…åŠŸèƒ½
          - IPv6 å®Œæ•´æ”¯æŒ
          - Passwall + Nikki (Mihomo)
          - Lucky (DDNS/STUN)
          - Samba4 æ–‡ä»¶å…±äº«
          - MosDNS + AdGuard Home
          
          ### ğŸ§Š ç‰ˆæœ¬ä¿¡æ¯
          ${{ env.VERSION_INFO }}

    - name: Delete Old Workflows
      uses: Mattraks/delete-workflow-runs@main
      with:
        retain_days: 3
        keep_minimum_runs: 3
